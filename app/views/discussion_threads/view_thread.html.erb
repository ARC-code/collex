<%
    # ------------------------------------------------------------------------
    # Copyright 2009 Applied Research in Patacriticism and the University of Virginia
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #    http://www.apache.org/licenses/LICENSE-2.0
  
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    # ---------------------------------------------------------------------------- -%>

<% current_page "Discuss" -%>
<% user_id = session[:user] ? User.find_by_username(session[:user][:username]).id : nil -%>
<% topic_id = params[:topic_id] -%>
<% thread_id = @thread.id -%>

<script language="JavaScript">
	var gIllustrationTypes = <%= ExhibitIllustration.get_illustration_type_array_with_exhibit() %>;
	var gCollectedObjects = <%= user_id ? CollectedItem.get_collected_object_array(user_id) : "[]" %>;
	var gExhibitNames = [ <%= Exhibit.js_array_of_all_public_exhibits() %> ];
</script>

<div  id="discussion_thread" class="tag_minor_nav"> 
	<%= link_to "View All Discussion Topics", { :action => 'index' }, :class => 'nav_link' %><br />
</div>

<%= render( :partial => '/results/result_count' ) %>
<%= rounded_h1("<a href='/discussion_threads/rss/#{thread_id}.xml'><img src='/images/RSS_icon.gif' height='16px' alt='RSS'/></a>&nbsp;Follow this discussion on RSS") %>
<div class="standard_box">
	<%= render( :partial => 'results/pagination', :locals => { :page => @page, :num_pages => @num_pages, :destination_hash => { :controller => 'destination_threads', :action => 'view_thread' } } ) %>
	<h2>Discuss the following:</h2>
	<% main_comment = @thread.discussion_comments[0] -%>
	<%= render :partial => 'comment', :locals => { :comment=> main_comment, :thread_id => @thread.id, :thread_link => false } %>
	<hr />
	<% 1.upto(@thread.discussion_comments.length-1) do |i| -%>
		<%= render :partial => 'comment', :locals => { :comment=> @thread.discussion_comments[i], :thread_id => @thread.id, :thread_link => false } %>
	<% end -%>

	<%= render( :partial => 'results/pagination', :locals => { :page => @page, :num_pages => @num_pages, :destination_hash => { :controller => 'destination_threads', :action => 'view_thread' } } ) %>
</div>
<div class="discussion_action_bar">
	<% if is_logged_in? -%>
		<%= rounded_button("post comment", "post_comment_id", 
			"var dlg = new NewDiscussionCommentDlg({ thread_id: #{@thread.id}, submit_url: '/discussion_threads/post_comment_to_existing_thread', parent_id: 'discussion_thread' }); dlg.show(); return false;") %>
		<%= rounded_button("post object", "post_object_id", 
			"var dlg = new NewDiscussionObjectDlg({ thread_id: #{@thread.id}, obj_list: gCollectedObjects, exhibit_list: gExhibitNames, type_list: gIllustrationTypes, submit_url: '/discussion_threads/post_object_to_existing_thread', parent_id: 'discussion_thread' }); dlg.show(); return false;") %>
	<% end -%>
</div>

<!--
-button: start discussion (next to each topic)
-comment item:
	-button: delete comment/object [if admin or user who posted]
	-button: report. if objectionable
	-user's name [ link to their home page ]
	-date/time
	-user's profile pic

When the user adds an object to the discourse, a single line message appears followed by the object added.
The message reads: “ has added the following object to the discourse…”

Once a comment is posted, the user who posted the comment has the option to delete the comment by 
clicking on a red “X” in the top right hand side of the comment row. Admins have a red “X” always available 
and can delete anything posted or any threads. A “Are You Sure?” confirmation dialog guards the delete 
function. Please also be sure to make this and other destructive actions POST requests so it can’t be 
spidered by Google Web Accelerator or other such programs.

If a user finds something that another user has posted objectionable, they can click on the “Report” button. 
This is guarded by an “Are You Sure?” dialog. If the user affirms their intent to report the content, a popup 
appears informing them that an email message has been sent to the site administrator. The email is sent to 
a list of addresses configurable via config/environments files. The email includes the post that was objected 
to and a link to it on the site.

Note that the user’s name is a link to their home page.

Subsequent comments within a discussion are not given a title, instead the user’s name and the date posted 
are shown. 
-->
