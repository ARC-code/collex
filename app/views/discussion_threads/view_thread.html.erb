<%
    # ------------------------------------------------------------------------
    # Copyright 2009 Applied Research in Patacriticism and the University of Virginia
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #    http://www.apache.org/licenses/LICENSE-2.0
  
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    # ---------------------------------------------------------------------------- -%>

<% current_page "Discuss" -%>
<% user_id = session[:user] ? User.find_by_username(session[:user][:username]).id : nil -%>
<% topic_id = params[:topic_id] -%>
<% thread_id = @thread.id -%>

<script language="JavaScript">
	var gIllustrationTypes = <%= ExhibitIllustration.get_illustration_type_array_with_exhibit() %>;
	var gCollectedObjects = <%= user_id ? CollectedItem.get_collected_object_array(user_id) : "[]" %>;
	var gExhibitNames = [ <%= Exhibit.js_array_of_all_public_exhibits() %> ];
</script>

<div  id="discussion_thread" class="tag_minor_nav"> 
	<%= link_to "View All Discussion Topics", { :action => 'index' }, :class => 'nav_link' %><br />
</div>

<%= render( :partial => '/results/result_count' ) %>
<%= rounded_h1("<a href='/discussion_threads/rss/#{thread_id}.xml'><img src='/images/RSS_icon.gif' height='16px' alt='RSS'/></a>&nbsp;Follow this discussion on RSS") %>
<div class="standard_box">
	<div class="discuss_following">
		Discuss the following:
	</div>
	<% main_comment = @thread.discussion_comments[0] -%>
	<%= render :partial => 'comment', :locals => { :comment=> main_comment, :thread_id => @thread.id, :thread_link => false, :can_delete => false, :is_main => true } %>
	<%= render( :partial => 'results/pagination', :locals => { :page => @page, :num_pages => @num_pages, :destination_hash => { :controller => 'destination_threads', :action => 'view_thread' } } ) %>
	<% 1.upto(@thread.discussion_comments.length-1) do |i| -%>
		<%= render :partial => 'comment', :locals => { :comment=> @thread.discussion_comments[i], :thread_id => @thread.id, :thread_link => false, :can_delete => is_logged_in? && (is_admin? || (@thread.discussion_comments[i].user_id == user_id)), :is_main => false  } %>
	<% end -%>

	<%= render( :partial => 'results/pagination', :locals => { :page => @page, :num_pages => @num_pages, :destination_hash => { :controller => 'destination_threads', :action => 'view_thread' } } ) %>
</div>
<div class="discussion_action_bar">
	<% if is_logged_in? -%>
		<%= rounded_button("post comment", "post_comment_id", 
			"var dlg = new NewDiscussionCommentDlg({ thread_id: #{thread_id}, submit_url: '/discussion_threads/post_comment_to_existing_thread', parent_id: 'discussion_thread' }); dlg.show(); return false;", 'red') %>
		<%= rounded_button("post object", "post_object_id", 
			"var dlg = new NewThreadObjectDlg({thread_id: #{thread_id}, obj_list: gCollectedObjects, exhibit_list: gExhibitNames, type_list: gIllustrationTypes, submit_url: '/discussion_threads/post_object_to_existing_thread', parent_id: 'discussion_thread' }); dlg.show(); return false;", 'red') %>
	<% end -%>
</div>

<!--
When the user adds an object to the discourse, a single line message appears followed by the object added.
The message reads: “ has added the following object to the discourse…”
-->
