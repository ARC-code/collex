<% #
    # ------------------------------------------------------------------------
    # Copyright 2009 Applied Research in Patacriticism and the University of Virginia
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #    http://www.apache.org/licenses/LICENSE-2.0
  
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    # ---------------------------------------------------------------------------- -%>
<% # illustration params: bool edit_mode, ActiveRecord illustration, int element_id, bool part_of_row -%>

<% # Set up all variables in advance to make the html code cleaner -%>
<% illustration_id = illustration.id -%>
<% url = illustration.image_url -%>
<% link = illustration.link -%>
<% link_style = 'ext_pic_link' -%>
<% alt = "" -%>
<% if illustration.illustration_type == ExhibitIllustration.get_illustration_type_nines_obj()
	url = CachedResource.get_image_from_uri(illustration.nines_object_uri)
	url = get_image_url("") if url == "" && illustration.nines_object_uri != nil && illustration.nines_object_uri != ""
	link = CachedResource.get_link_from_uri(illustration.nines_object_uri)
	link = "" if link == nil
	link_style = 'nines_pic_link'
	ht = CachedResource.get_hit_from_uri(illustration.nines_object_uri) if illustration.nines_object_uri
	alt = ht['title'] if ht
end -%>
<% alt = illustration.alt_text if illustration.alt_text && illustration.alt_text.length > 0 %>
<% alt = "Picture" if alt.length == 0 -%>
<% url = EXHIBIT_BUILDER_TODO_PATH if url == nil || url == "" %>
<% url = get_image_url(url) -%>
<% width = illustration.image_width -%>
<% height = illustration.height != nil ? "min-height:#{illustration.height}px;" : "" -%>
<% illustration_position = illustration.position -%>
<% illustration_type = illustration.illustration_type -%>
<% create_resizable = "" %>

<% if edit_mode -%>
	<% wrapper_type = 'edit' -%>
	<% ajax_action = "'/my9s/edit_row_of_illustrations,/my9s/refresh_outline'" -%>
	<% ajax_div_id = "'element_#{element_id},exhibit_builder_outline_content'" -%>
	<% ajax_params = "'element_id=#{element_id}&position=#{illustration_position}&verb='" -%>
	<% onload_text = "onload=\"initializeResizableImageElement('illustration_img_#{illustration_id}');\"" -%>
	<% if illustration_type == ExhibitIllustration.get_illustration_type_text() -%>
		<% create_resizable = "<script type='text/javascript'>\n\tinitializeResizableTextualElement('illustration_img_#{illustration_id}');\n</script>\n" -%>
	<% end -%>
	<% illustration_text = illustration.illustration_text -%>
<% else -%>
	<% illustration_text = decode_exhibit_links(illustration.illustration_text) -%>
	<% element_id = -1 -%>
	<% if link == "" -%>
		<% wrapper_type = 'none' -%>
	<% else -%>
		<% wrapper_type = 'link' -%>
	<% end -%>
	<% onload_text = "onload=\"hideSpinner('illustration_img_#{illustration_id}');\"" -%>
<% end -%>

<div id='illustration_<%= illustration_id %>' class="illustration_block">
	<center>
	<div class="exhibit_illustration">
		<% # The wrapper is either nothing, if this is live and there was no link specified, or the link if specified, or a table if we are in edit mode. -%>
		<% if wrapper_type == 'link' -%>
			<a class='<%= link_style %>' target="_blank" href="<%= link %>">
		<% elsif wrapper_type == 'edit' -%>
			<% # We are creating a table with one row and 3 cols: the two outer cols are for the move left and move right controls. -%>
				<table><tr>
				<% if part_of_row && illustration_position > 1 -%>
					<td class="edit_illustration_column"><a title="Move Illustration Left" onclick="doAjaxLink(<%= ajax_div_id %>, <%= ajax_action %>, <%= ajax_params %> + 'left'); return false;" href="#"><img src="/images/left-image-arrow.gif" alt="" /></a></td>
				<% end -%>
				
				<td class="edit_illustration_column"><div class="illustration_control_border">
					<% if part_of_row == true -%>
						<div class="outline_right_controls_no_space">
							<span class="close_link"><%= link_to_function del_char(), "doAjaxLink(#{ajax_div_id}, #{ajax_action}, #{ajax_params}+'delete');", { :title => 'Remove Illustration', :class => 'modify_link' } %></span>
						</div>
					<% end -%>
		<% end -%>
		
		<div id='illustration_inner_<%= illustration_id %>' class="illustration_inner">
			<% #Put all the data on the page in hidden divs so that the javascript for the dialog can pick it up %>
			<% if edit_mode -%>
				<div class="saved_data ill_illustration_type" style="display:none;"><%= illustration.illustration_type %></div>
				<div class="saved_data ill_image_url" style="display:none;"><%= illustration.image_url %></div>
				<div class="saved_data ill_link" style="display:none;"><%= illustration.link %></div>
				<div class="saved_data ill_image_width" style="display:none;"><%= illustration.image_width %></div>
				<div class="saved_data ill_illustration_text" style="display:none;"><%= illustration.illustration_text %></div>
				<div class="saved_data ill_illustration_alt_text" style="display:none;"><%= illustration.alt_text %></div>
				<div class="saved_data ill_illustration_caption1" style="display:none;"><%= illustration.caption1 %></div>
				<div class="saved_data ill_illustration_caption2" style="display:none;"><%= illustration.caption2 %></div>
				<div class="saved_data ill_illustration_caption1_footnote" style="display:none;"><%= illustration.caption1_footnote_id ? ExhibitFootnote.find(illustration.caption1_footnote_id).footnote : "" %></div>
				<div class="saved_data ill_illustration_caption2_footnote" style="display:none;"><%= illustration.caption2_footnote_id ? ExhibitFootnote.find(illustration.caption2_footnote_id).footnote : ""  %></div>
				<div class="saved_data ill_nines_object_uri" style="display:none;"><%= illustration.nines_object_uri %></div>
			<% end -%>
		
			<% # Create the actual content -%>	
			<% if illustration_type == ExhibitIllustration.get_illustration_type_text() -%>
				<div class="exhibit_illustration_text widenable" id='illustration_img_<%= illustration_id %>' style='width:<%= width %>px;<%= height %>'><%= illustration_text %></div>
				<%= create_resizable -%>
			<% else # nines object or internet image -%>
				<img class="exhibit_illustration_img" id='spinner_illustration_img_<%= illustration_id %>' src="<%= PROGRESS_SPINNER_PATH %>" alt="<%= alt %>" />
				<img class="exhibit_illustration_img widenable hidden" id='illustration_img_<%= illustration_id %>' src="<%= url %>" width="<%= width %>px" alt="<%= alt %>" <%= onload_text %> />
			<% end -%>
		</div>
	
		<% # Close the wrapper created above -%>
		<% if wrapper_type == 'link' -%>
			</a>
		<% elsif wrapper_type == 'edit' -%>
			<% # </a>	 The link to the edit dialog -%>
			</div> <% # The illustration control border -%>
			</td>	<% # The middle column containing the content and the image control stuff -%>
			
			<% if part_of_row && illustration_position < ExhibitElement.find(element_id).exhibit_illustrations.length %>
				<td class="edit_illustration_column"><a title="Move Illustration Right" onclick="doAjaxLink(<%= ajax_div_id %>, <%= ajax_action %>, <%= ajax_params %> + 'right'); return false;" href="#" ><img src="/images/right-image-arrow.gif" alt="" /></a></td>
			<% end -%>
			</tr></table>
		<% end -%>
	
		<% # draw the caption(s) -%>
		<% if illustration != nil -%>
			<% if illustration.caption1 && illustration.caption1.length > 0 -%>
				<div class="exhibit_caption1" style="width:<%= illustration.image_width + 10 %>px"><%= illustration.caption1 %>
				<%= draw_footnote(illustration.caption1_footnote_id, "caption1_#{id}", edit_mode) %>
				<% if illustration.caption2 && illustration.caption2.length > 0 -%>
					<div class="exhibit_caption2"><%= illustration.caption2 %>
					<%= draw_footnote(illustration.caption2_footnote_id, "caption2_#{id}", edit_mode) %>
					</div>
				<% end -%>
				</div>
			<% else -%>
				<% if illustration.caption2 && illustration.caption2.length > 0 -%>
					<div class="exhibit_caption2" style="width:<%= illustration.image_width + 10 %>px"><%= illustration.caption2 %>
						<%= draw_footnote(illustration.caption2_footnote_id, "caption2_#{id}", edit_mode) %>
					</div>
				<% end -%>
			<% end -%>
		<% end -%>
	</div>
	</center>
</div>
<% if edit_mode -%>
	<script type="text/javascript">
		if(window.initializeInplaceIllustrationEditor)
			initializeInplaceIllustrationEditor(<%= "'illustration_inner_#{illustration_id},exhibit_builder_outline_content'"%>, "/my9s/edit_illustration,/my9s/refresh_outline");
	</script>
<% end -%>
