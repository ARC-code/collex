<%
    # ------------------------------------------------------------------------
    # Copyright 2009 Applied Research in Patacriticism and the University of Virginia
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #    http://www.apache.org/licenses/LICENSE-2.0
  
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    # ---------------------------------------------------------------------------- -%>
<% # params: ActiveRecord comment, int thread_id, bool can_delete, bool is_main -%>

<div class="<%= is_main ? 'new_discussion' : 'discussion_thread_list' %>">
	<div class="discussion_comment2">
	<% if comment.reported == 1 && can_delete -%>
		<div class="reported_comment">
			NOTICE: This comment has been reported as objectionable by <%= user.fullname %>, and is pending moderation.
		</div>
	<% end -%>

	<% if comment.get_type() == "comment" -%>
		<% if is_main -%>
			<span class="discussion_title"><%= DiscussionThread.find(thread_id).title %></span>
		<% end -%>
		<%= render :partial => 'comment_template', :locals => { :picture_src => get_user_picture(comment.user_id, :thumb), :picture_alt => 'user', :comment => comment, :can_delete => !is_main && can_delete } %>

		<% if !is_main -%>
			<span class="discussion_comment_title">	<%= get_user_link(User.find(comment.user_id)) %> comments:</span>
		<% end -%>
		<div class="discussion_thread_margin">
			<%= decode_exhibit_links(comment.comment) %>
		</div>
		
		<%= render :partial => 'comment_template2', :locals => { :comment => comment, :include_username => is_main, :include_report => true } %>
		
	<% elsif comment.get_type() == "nines_exhibit" -%>
		<% exhibit = Exhibit.find(comment.exhibit_id) -%>
		<%= render :partial => 'added_object', :locals => {:comment => comment, :title => 'exhibit', :is_first => comment.position == 1 } %>
		<%= render :partial => 'comment_template', :locals => { :picture_src => exhibit.thumbnail, :picture_alt => 'exhibit', :comment => comment, :can_delete => !is_main && can_delete  } %>
		<h3><%= get_exhibit_link(exhibit) %></h3>
		<div class="discussion_thread_margin"><%= decode_exhibit_links(comment.comment) %></div>
		<%= render :partial => 'comment_template2', :locals => { :comment => comment, :include_username => true, :include_report => true } %>
		
	<% elsif comment.get_type() == "inet_object" -%>
		<%= render :partial => 'added_object', :locals => {:comment => comment, :title => 'link', :is_first => comment.position == 1 } %>
		<%= render :partial => 'comment_template', :locals => { :picture_src => comment.image_url, :picture_alt => 'thumbnail', :comment => comment, :can_delete => !is_main && can_delete  } %>
		<%=make_ext_link(comment.link_url) %>
		<div class="discussion_thread_margin"><%= decode_exhibit_links(comment.comment) %></div>
		<%= render :partial => 'comment_template2', :locals => { :comment => comment, :include_username => true, :include_report => true } %>

	<% elsif comment.get_type() == "nines_object" -%>
		<% hit = CachedResource.get_hit_from_resource_id(comment.cached_resource_id) -%>
		<%= render :partial => 'added_object', :locals => {:comment => comment, :title => 'object', :is_first => comment.position == 1 } %>
		<%= link_to del_char(), "/forum/delete_comment?comment=#{comment.id}", :confirm => 'Are you sure?', :method => :delete, :class => 'modify_link', :style => 'float:right;' if can_delete %>
		<table><tr>
			<%= render :partial => '/results/result_row', :locals => { :row_id => "test", :index => 2, :hit => hit, :has_exhibits => false, :add_border => false } %>
		</tr><tr><td></td><td colspan='4'>
			<hr>
			<%= decode_exhibit_links(comment.comment) %>
		</td></tr><tr><td></td><td colspan='4'>
			<%= render :partial => 'comment_footer', :locals => { :comment => comment, :include_username => true, :include_report => false, :include_last_updated => false } %>
		</td></tr></table>
		<% else -%>
			ERROR: ill-formed comment. (Comment type <%- comment.comment_type %> is unknown)
		<% end -%>
	</div>
</div>
