<%
    # ------------------------------------------------------------------------
    # Copyright 2009 Applied Research in Patacriticism and the University of Virginia
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #    http://www.apache.org/licenses/LICENSE-2.0
  
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    # ---------------------------------------------------------------------------- -%>

<% current_page "Forum" -%>
<% user_id = session[:user] ? User.find_by_username(session[:user][:username]).id : nil -%>
<% thread_id = @thread.id -%>
<% topic = DiscussionTopic.find(@thread.discussion_topic_id) -%>

<div class="page_subheader">Follow and join in this discussion by using your free NINES account.</div>
<a href='/forum/rss/<%=thread_id%>.xml'><img src='/images/RSS_icon.gif' height='16px' alt='RSS'/></a>&nbsp;Follow this discussion on RSS
<div class="FP_breadcrumb">
	<%= link_to "Nines Forum", { :action => 'index' }, :class => 'nav_link' %> > <%= link_to topic.topic, { :action => 'view_topic', :topic => topic.id }, :class => 'nav_link' %> > <%= DiscussionThread.find(thread_id).get_title() %>
</div>
<% main_comment = @thread.discussion_comments[0] -%>
<%= render :partial => 'comment', :locals => { :comment=> main_comment, :thread_id => @thread.id, :can_delete => false, :is_main => true } %>

<div id="replies" class="FP_replies">
	<%= render :partial => 'replies', :locals => { :total => @total, :page => @page, :replies => @replies, :num_pages => @num_pages, :thread => @thread } %>

	<div id="discussion_thread" class="discussion_action_bar">
		<%= link_to("Reply", "#", :onclick => 'return false;', :id => 'replyButton', :class => 'modify_link') %>
		<script type="text/javascript">
			document.observe('dom:loaded', function() {
			    var onButtonClick = function (e) {
			        new ForumReplyDlg({ thread_id: <%= @thread.id %>, 
						ajax_div: 'replies',
						submit_url: '/forum/post_comment_to_existing_thread', 
						populate_exhibit_url: '/forum/get_exhibit_list',
						populate_nines_obj_url: '/forum/get_nines_obj_list',
						progress_img: '<%= PROGRESS_SPINNER_PATH %>',
						logged_in: <%= is_logged_in? %>
					});
					return false;
			    };
			    var oButton = new YAHOO.widget.Button("replyButton", { onclick: { fn: onButtonClick } });
				YAHOO.util.Event.onAvailable('replyButton-button', function() {
					$('replyButton-button').writeAttribute('onclick', 'return false;');	// This keeps the '#' out of the address bar
				}, this);
			});
		</script>
	</div>
</div>
