<% # 
    # ------------------------------------------------------------------------
    # Copyright 2009 Applied Research in Patacriticism and the University of Virginia
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #    http://www.apache.org/licenses/LICENSE-2.0
  
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    # ---------------------------------------------------------------------------- -%>
<%# group_details : parameters: ActiveRecord group, int user_id -%>
<script type="text/javascript">
	// These have to be global variables to be picked up after an ajax call (this partial is redrawn after every update.)
	<% membership = group.get_membership_list() -%>
	gMembership = <%= membership.to_json() %>;
	gGroupData = <%= group.to_json() %>.group;
</script>
<div class="group_details_left">
	<%= render :partial => 'common/thumbnail', :locals => { :element_id => "group_#{group.id}", :url => get_image_url(get_url_for_internal_image(group.image)), :show_immediately => true, :height => 120, :border => true } %>
	<% if group.can_edit(user_id) -%>
		<br /><%= link_to_function("[#{group.image == nil ? 'add' : 'edit'} thumbnail]", "new EditGroupThumbnailDlg(#{group.id}, '#{get_url_for_internal_image(group.image)}');", :class => 'nav_link') %>
		<% if group.image != nil -%>
		<div class="profile_remove_picture"><%= link_to "Remove Thumbnail", { :controller => 'groups', :action => 'remove_profile_picture', :id => group.id }, { :id => 'remove_picture', :method => 'post' } %></div>
		<script type="text/javascript">
			var createRemovePictureButton = function() {
				var onButtonClick = function (e) {
					postLink($("remove_picture-button").href);
				};


				new YAHOO.widget.Button('remove_picture', { onclick: { fn: onButtonClick } });
				YAHOO.util.Event.onAvailable('remove_picture-button', function() {
					$('remove_picture-button').writeAttribute('onclick', 'return false;');	// This keeps the '#' out of the address bar
				}, this);
			};
			document.observe('dom:loaded', function() {
				createRemovePictureButton();
			});
			try {
				createRemovePictureButton();
			} catch(e) {};
		</script>
		<% end -%>
	<% end -%>
</div>
<div class="group_details_right">
	<ul class="group_link_list">
		<!-- <li class="group_back_to_exhibits_link"><%= link_to "[ Back to Exhibits List ]", "/exhibits", :class => 'nav_link' %></li> -->
		<% if group.can_edit(user_id) || group.show_membership %>
		<% membership.insert(0, { :user_id => group.owner}) -%>
		<%# 0.upto(5) do membership = membership + membership end -%>
		<li><span class="group_details_label">Group Membership</span>
			<div class="group_member_explanation">This group has <%= pluralize(membership.length, "member")  %>. (hover over each thumbnail to see the user's name)</div>
		<div class="group_member_palette_items">
		<table>
			<% count = 0 -%>
			<% 0.upto((membership.length/11.0).ceil()) do -%>
				<tr>
					<% 0.upto(6) do -%>
						<td>
							<% if count < membership.length -%>
								<%= get_user_link_with_thumbnail(membership[count][:user_id], 25) %>
								<% count = count + 1 -%>
							<% else -%>
								<div style="width:25px;height:25px;"></div>
							<% end -%>
						</td>
					<% end -%>
				</tr>
			<% end -%>
		</table>
		</div>
		</li>
		<% if group.can_edit(user_id) -%>
		<li><%= link_to_function('[invite users to join]', "new InviteMembersDlg(#{group.id});", :class => 'nav_link')  %></li>
		<li><%= link_to_function('[change membership]', "new EditMembershipDlg(#{group.id}, gMembership);", :class => 'nav_link')  %></li>
		<li><%= link_to_function("[change membership visibility]", "editShowMembership(#{group.id}, '#{group.show_membership == true ? 'Yes' : 'No' }'); return false;", { :class => "nav_link" }) %></li>
		<% end -%>
	<% end -%>
	<% if user_id -%>
		<% pending_id = group.get_pending_id(user_id) -%>
		<% if pending_id -%>
		You have been invited to join this group.
		<%= "<li>#{link_to_function('[accept invitation to join]', "accept_invitation(#{pending_id});", :class => 'nav_link');}</li>" %>
		<%= "<li>#{link_to_function('[ignore invitation to join]', "decline_invitation(#{pending_id});", :class => 'nav_link');}</li>" %>
		<% elsif group.can_request_to_join(user_id) -%>
		<%= "<li>#{link_to_function('[join]', "request_to_join(#{group.id}, #{user_id});", :class => 'nav_link' )}</li>" %>
		<% elsif group.can_leave_group(user_id) -%>
		<%= "<li>#{link_to_confirm("[leave this group]", { :controller => 'groups', :action => 'leave_group', :group_id => group.id, :user_id => user_id }, "Leave Group", "Are you sure you want to leave this group?")}</li>" %>
		<% elsif group.is_request_pending(user_id) -%>
		<%= "<li>[a request to join this group is pending acceptance by the moderator]</li>" -%>
		<% end -%>
		<% if group.can_edit(user_id) -%>
			<% gus = GroupsUser.get_all_pending_requests(group.id) -%>
			<% if gus.length > 0 -%>
			<li>The following people have requested to join this group:</li>
				<% gus.each { |gu| -%>
				<li><%= get_user_link(gu.user_id) %>&nbsp;<%= link_to_function("[accept]", "accept_request(#{Group.id_obfuscator(gu.id)});", :class => 'nav_link') %>&nbsp;<%= link_to_function("[deny]", "decline_request(#{Group.id_obfuscator(gu.id)});", :class => 'nav_link') %></li>
				<% } -%>
			<% end -%>
		<% end -%>
	<% end -%>
	</ul>
</div>
<div class="group_details_center">
	<h1><%=h group.name %><%= link_to_function('[edit title]', "editTitle(#{group.id}, '#{group.name}');", :class => 'group_edit_title_link nav_link') if group.can_edit(user_id) %></h1>
	<div class="group_editors"><% editors = group.get_all_editors() -%>
		<span class="group_details_label">Group Editor<%= 's' if editors.length > 1 %>:</span>
		<% for editor in editors -%>
			<%= get_user_link(editor) %>&nbsp;
		<% end -%>
	</div>
	<div class="group_description_label"><span class="group_details_label">Group Description</span> <%= link_to_function('[edit]', "editDescription(#{group.id}, '#{group.description.gsub("\n", "").gsub('\'') { |apos| '\\\'' }}');", :class => 'nav_link') if group.can_edit(user_id) %></div>
	<div class="group_description"><%=h(group.description).gsub("\n", "<br />") %></div>
	<div class="group_editors"><span class="group_details_label">Group Type: </span><%= Group.type_to_friendly(group.group_type) %> <%= link_to_function('[edit group type]', "editType(#{group.id}, '#{group.group_type}', #{Group.types_to_json()});", :class => 'nav_link') if group.can_edit(user_id) %></div>
	<% if group.can_edit(user_id) -%>
	<div class="group_editors"><span class="group_details_label">License: </span><%= link_to_function("[change license]", "license_dialog({ populateLicenses: '/my9s/get_licenses?add_inherit=true', selection: gLicenseType, id_name: 'group[license_type]', id: #{group.id}, update_id: 'group_license', sub_title: 'All exhibits in this group use the following license:', callback_url: '/groups/update' }); return false;", { :class => "nav_link" }) %></div>
	<% end -%>
	<div class="group_editors"><%= link_to('[delete group]', group, :confirm => 'Are you sure you wish to permanently delete this group?', :method => :delete, :class => 'nav_link') if group.can_delete(user_id) %></div>
</div>
<div class="clear_both"></div>
