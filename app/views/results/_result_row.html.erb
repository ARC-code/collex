<%
    # ------------------------------------------------------------------------
    # Copyright 2009 Applied Research in Patacriticism and the University of Virginia
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #    http://www.apache.org/licenses/LICENSE-2.0
  
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    # ---------------------------------------------------------------------------- -%>
	
<% #  parameters: int row_id; int index; hit hit; bool has_exhibits; -%>
	    <%# The left side that contains the checkbox, graphic and the collect button -%>
	    <td valign="top">
	        <table border="0">
	            <tr>
	            	<% if is_logged_in? -%>
	                <td rowspan="2" valign="middle" align="left" width="10" class="thumbview">
	                    <input type="checkbox" id="bulk_collect_<%=index%>" name="bulk_collect[<%=index%>]" value="<%=hit['uri']%>" style="display: none;"/>
	                </td>
<script language="JavaScript">
	var bulk_form = $("bulk_collect_form");
	if (bulk_form != null)
		$("bulk_collect_<%=index%>").show();
</script>  
					<% end -%>
	                <td rowspan="1" valign="top" align="left" width="100" class="thumbview">
	                    <%= thumbnail_image_tag(hit) %>
	                </td>
	            </tr>
	        </table>
	    </td>

	    <%# The middle with the actual search results -%>
        <td class="result_row_td">
            <table border="0">
                <tr>
                    <td colspan="2">
                        <% if hit["url"] %>
                        	<a class="nines_link search-result-title" target="_blank" href="<%= hit["url"][0] %>"><%= h hit["title"][0] if hit["title"] %></a>
						<% else %>
                        	<%= h hit["title"][0] if hit["title"] %>
                        <% end %>
                    </td>
                </tr>
				<%= render :partial => '/results/hit_body', :locals => { :hit => hit, :row_id => row_id, :index => index, :no_links => false } %>
				<% exhibits = ExhibitObject.find_all_by_uri(hit['uri']) -%>
				<% is_first = true -%>
				<% user_name = session[:user] ? session[:user][:username] : nil -%>
				<% for exhibit in exhibits -%>
					<% # We only want to display the exhibit if it can be viewed, so only if it is owned by the current user, or is public -%>
					<% # We only want to have the edit link if it is owned by the current user. -%>
					<% real_exhibit = Exhibit.find(exhibit.exhibit.id) -%>
					<% owner = User.find(real_exhibit.user_id) -%>
					<% if user_name == owner.username || real_exhibit.published? -%>
						<tr class="hidden" id="in_exhibit_<%= exhibit.exhibit.id %>_<%= hit['uri'] %>">
							<td class='grey' valign='top'>
								<%= "Exhibits:" if is_first == true -%>
								<% is_first = false -%>
							</td>
							<td valign='top' width='100%'>
								<%= real_exhibit.title -%>
								<a class="nav_link" href="/exhibits/<%= real_exhibit.visible_url != nil && real_exhibit.visible_url.length > 0 ? real_exhibit.visible_url : real_exhibit.id %>" >[view]</a>
								<% if user_name == owner.username -%>
									<%= link_to("[edit]", { :controller => 'my9s', :action => 'edit_exhibit', :id => real_exhibit.id }, :class => 'nav_link' ) %>
								 <% end -%>
							</td>
						</tr>
					<% end -%>
				<% end # each exhibit -%>

				<tr id='more-<%= row_id %>' class="more">
					<td><%= link_to_function("[more...]", "removeHidden('more-#{row_id}', '#{row_id}');", { :id => "more-#{row_id}", :class => 'nav_link' }) %></td>
				<tr>
				<% if result_is_collected(hit) -%>
					<td colspan='2'>
						<%= link_to_function "#{has_annotation(hit)?"Edit":"Add"} Annotation", "doAnnotation('add_annotation_#{index}', '#{hit['uri']}', #{index}, '#{row_id}', 'annotation_#{index}');",  :id => "add_annotation_#{index}", :class => 'modify_link' %>
						<%= "<br />" if has_annotation(hit) -%>
						<span id="annotation_<%=index%>" class='annotation'><%= get_annotation(hit) %></span>
						<%= "<br/><span class='annotation'>#{hit['warning']}</span>" if hit['warning'] %>
					</td>
				</tr>
				<% end # if the item is collected -%>
				<tr>
					<td></td>
					<td align="right">
						<%= rounded_button("collect", "collect_#{index}", "doCollect('#{hit['uri']}', #{index}, '#{row_id}');", 'red') if is_logged_in? && !result_is_collected(hit) %>
						<%# rounded_button("collect", "collect_#{index}", "doSingleInputPrompt('Please sign in', 'You must be signed in to collect objects.', null, 'collect_#{index}', null, null, $H({ }), 'none', null);", 'red') if !is_logged_in? %>
						<%= rounded_button("uncollect", "uncollect_#{index}", "doRemoveCollect('#{hit['uri']}', #{index}, '#{row_id}');", 'red') if result_is_collected(hit) %>
						<% # = rounded_button("discuss", "discuss_#{index}", "doDiscuss('discuss_#{index}');", 'red') %>
						<%= rounded_button("exhibit", "exhibit_#{index}", "doAddToExhibit('#{hit['uri']}', #{index}, '#{row_id}');", 'red') if result_is_collected(hit) %>
					</td>
				</tr>
            </table>
			</td>

 